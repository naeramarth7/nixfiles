#!/bin/sh -e

RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FLAG="${1:-switch}"

if [[ "$FLAG" != "boot" && "$FLAG" != "switch" ]]; then
  echo -e "${RED}Error: Supported flags: 'boot', 'switch'${NC}"
  exit 1
fi

HOST="$(hostname)"
FLAKE_TARGET="$HOST"

export NIXPKGS_ALLOW_UNFREE=1

echo -e "${YELLOW}Starting build ($FLAG) for named host: $HOST${NC}"

sudo /run/current-system/sw/bin/nixos-rebuild $FLAG --flake .#$FLAKE_TARGET

if [[ "$FLAG" == "switch" ]]; then
  echo -e "${GREEN}Switch to new generation complete!${NC}"
fi

if [[ "$FLAG" == "boot" ]]; then
  echo -e "${YELLOW}Reboot required to apply changes.${NC}"
fi
